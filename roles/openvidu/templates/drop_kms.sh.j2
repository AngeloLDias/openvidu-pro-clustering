#!/bin/bash -x
set -e -o pipefail

export AWS_DEFAULT_REGION={{ aws_default_region }}

IP=$1
[ -z "${IP}" ] && { echo "Must provide IP address"; exit 1; }

# TODO: We have to decide which parameter this script will recived. 
#AWS_INSTANCE_ID=$(grep ${IP} /opt/openvidu/kms_list.txt | awk '{ print $1 }')
AWS_INSTANCE_ID=$(cat /opt/openvidu/kms_list.json | jq '.[] | select(.[].ip == "${IP}") | .[].id'

aws ec2 terminate-instances --instance-ids ${AWS_INSTANCE_ID}
